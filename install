#!/usr/bin/env zsh
set -e

DOTFILES_PATH="$HOME/.dotfiles"

if ! xcode-select -p >/dev/null 2>&1; then
  echo "Installing Xcode Command Line Tools"
  xcode-select --install
  while ! xcode-select -p > /dev/null 2>&1; do
    echo "Waiting for Xcode Command Line Tools to install..."
    sleep 1
  done
fi

if ! command -v brew >/dev/null; then
  echo "Installing Homebrew"
  bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi

echo "Installing common tools"
brew install coreutils git

echo "Installing SF Mono font"
brew install font-sf-mono

if [ ! -d "$DOTFILES_PATH" ]; then
  echo "Cloning dotfiles"
  git clone "https://github.com/mrrooijen/dotfiles.git" "$DOTFILES_PATH"
fi

echo "Creating $HOME/Developer directory"
mkdir -p "$HOME/Developer"

echo "Linking zsh configuration"
touch "$HOME/.zshrc.local"
touch "$HOME/.zprofile.local"
ln -vnfs "$DOTFILES_PATH/zsh/zshrc" "$HOME/.zshrc"
ln -vnfs "$DOTFILES_PATH/zsh/zprofile" "$HOME/.zprofile"

echo "Linking ssh configuration"
mkdir -p "$HOME/.ssh"
ln -vnfs "$DOTFILES_PATH/ssh/config" "$HOME/.ssh/config"

echo "Linking git configuration"
ln -vnfs "$DOTFILES_PATH/git/gitconfig" "$HOME/.gitconfig"

echo "Linking emacs configuration"
mkdir -p "$HOME/.emacs.d/straight/versions"
ln -vnfs "$DOTFILES_PATH/emacs/init.el" "$HOME/.emacs.d/init.el"
ln -vnfs "$DOTFILES_PATH/emacs/straight.lock.el" "$HOME/.emacs.d/straight/versions/default.el"

echo "Installing Ghostty"
ln -vnfs "$DOTFILES_PATH/ghostty/config" "$HOME/Library/Application Support/com.mitchellh.ghostty/config"
brew install --cask ghostty --force

echo "Installing Emacs"
brew tap d12frosted/emacs-plus
brew install emacs-plus@31 cmake libtool ag
rm -rf /Applications/Emacs.app
osascript -e 'tell application "Finder" to make alias file to posix file "/opt/homebrew/opt/emacs-plus@31/Emacs.app" at posix file "/Applications" with properties {name:"Emacs.app"}'

echo "Installing Rectangle"
mkdir -p "$HOME/Library/Application Support/Rectangle"
cp "$DOTFILES_PATH/rectangle/RectangleConfig.json" "$HOME/Library/Application Support/Rectangle/RectangleConfig.json"
brew install --cask rectangle --force

echo "Installing Mise"
brew install mise

echo "Installing Rust"
mise install rust
mise use -g rust

echo "Installing Ruby"
brew install autoconf pkgconf libyaml openssl
mise install ruby
mise use -g ruby

echo "Installing Python"
brew install pkgconf mpdecimal openssl sqlite xz
mise install python
mise use -g python

echo "Installing Node"
brew install pkgconf llvm brotli c-ares icu4c libnghttp2 libuv openssl
mise install node
mise use -g node

echo "Done"
